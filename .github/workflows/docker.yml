
name: app-server build


on:
  push:
    branches: [ master ]
  pull_request:
    branches: [staging]  


env:
  IMAGE_BASE_DIR: container

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Login Jfrog
        uses: docker/login-action@v1
        with:
          registry: zowe-docker-snapshot.jfrog.io
          username: ${{ secrets.ARTIFACTORY_X_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_X_PASSWORD }}
          
      - name: build and push image
        run: |
          cd container
          chmod +x *.sh
          ./pull-zowe-install-artifacts.sh
          ./download-zlux.sh
          cd files
          IMAGE_VERSION=$(grep -Po '"version": *\K"[^"]*"'  manifest.json | head -n1)
          IMAGE_VERSION=`echo $IMAGE_VERSION | sed 's/.\(.*\)/\1/' | sed 's/\(.*\)./\1/'`
          cd ..
          ./build.sh
          docker tag zowe-docker-snapshot.jfrog.io/ompzowe/app-server:testing zowe-docker-snapshot.jfrog.io/ompzowe/app-server:$IMAGE_VERSION
          docker push zowe-docker-snapshot.jfrog.io/ompzowe/app-server:$IMAGE_VERSION
   

  build-zlinux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      

      - uses: zowe-actions/shared-actions/docker-prepare@main
        with:
          registry-user: ${{ secrets.ARTIFACTORY_X_USERNAME }}
          registry-password: ${{ secrets.ARTIFACTORY_X_PASSWORD }}
          release: ${{ github.event.inputs.release }}
          base-directory: ${{ env.IMAGE_BASE_DIR }}
          image-name: app-server
          linux-distro: ubuntu
          cpu-arch: s390x

      - uses: zowe-actions/shared-actions/docker-build-zlinux@main
        with:
          zlinux-host: ${{ secrets.ZLINUX_HOST }}
          zlinux-ssh-user: ${{ secrets.ZLINUX_SSH_USER }}
          zlinux-ssh-key: ${{ secrets.ZLINUX_SSH_KEY }}
          zlinux-ssh-passphrase: ${{ secrets.ZLINUX_SSH_PASSPHRASE }}
          build-arg-list: ZOWE_BASE_IMAGE=latest-ubuntu
        timeout-minutes: 10